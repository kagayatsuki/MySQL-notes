# 窗口函数

例题：

184. 部门工资最高的员工

从 Employee 和 Department 表中找出每个部门薪资最高的员工，输出部门名称、员工姓名和薪资。

[https://leetcode.cn/problems/department-highest-salary/description/](https://leetcode.cn/problems/department-highest-salary/description/)

窗口函数在 SQL 中通过在查询结果的“窗口”（一组相关行）上执行计算，生成与每行关联的结果。窗口函数不会像 GROUP BY 那样将多行聚合成一行，而是为每行返回一个计算结果，保留原始数据的结构。

窗口函数通常在 SELECT 子句中使用，结合 OVER 子句定义窗口。基本语法如下：

```sql
<窗口函数>(<表达式>) OVER (
    [PARTITION BY 列名1, 列名2, ...] -- PARTITION BY 定义了数据分组的方式，将结果集分成多个分区，分区里面进行细化比较
    [ORDER BY 列名 [ASC|DESC], ...]
    [ROWS 或 RANGE 窗口框架]
)
```

* 窗口函数：执行的具体计算，如 ROW_NUMBER()、RANK()、SUM() 等。
* OVER 子句：定义窗口的范围和行为：
* * PARTITION BY：将数据分成多个分区（类似 GROUP BY），窗口函数在每个分区内独立计算。如果省略，则整个结果集为一个窗口。
  * ORDER BY：在窗口内对行排序，影响窗口函数的计算顺序（如累计和或排名）。
  * 窗口框架（ROWS 或 RANGE）：定义窗口的行范围，例如“当前行到前一行”或“整个分区”。

我们主要讲解排名函数：

* **ROW_NUMBER()**：为每行分配一个唯一序号，即使值相同。
* **RANK()**：分配排名，相同值排名相同，但会跳过后续排名（例如 1, 1, 3）。
* **DENSE_RANK()**：类似 **RANK()**，但排名连续（例如 1, 1, 2）。

让我们回到题目：

```sql
SELECT 
    d.name AS Department,
    e.name AS Employee,
    e.salary AS Salary
FROM (
    SELECT 
        name,
        salary,
        departmentId,
        RANK() OVER (PARTITION BY departmentId ORDER BY salary DESC) AS rnk -- 每行增加一个 rnk 列表示排名
    FROM 
        Employee
) e --为表取的别名e
JOIN 
    Department d ON e.departmentId = d.id --外连接
WHERE 
    e.rnk = 1;-- 第一的薪水
```

~~如果我们运行这个子查询，结果是：~~

```*
+-------+--------+--------------+-----+
| name  | salary | departmentId | rnk |
+-------+--------+--------------+-----+
| Jim   | 90000  | 1            | 1   |
| Max   | 90000  | 1            | 1   |
| Joe   | 70000  | 1            | 2   |
| Henry | 80000  | 2            | 1   |
| Sam   | 60000  | 2            | 2   |
+-------+--------+--------------+-----+
```

感觉可以更方便理解（）
